## Copyright 2023 Databend Cloud
##
## Licensed under the Elastic License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     https://www.elastic.co/licensing/elastic-license
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.

statement ok
DROP DATABASE IF EXISTS test_computed_column

statement ok
CREATE DATABASE test_computed_column

statement ok
USE test_computed_column

statement ok
drop table if exists t_stored

statement error mysql client error: Server error: `ERROR HY000 \(1105\): LicenseKeyInvalid\. Code: 1402, Text = use of computed_column requires an enterprise license\. current license is invalid for test_tenant, cause: LicenseKeyParseError\. Code: 1401, Text = jwt claim decode failed, cause: Token has expired\.\.'
create table t_stored(a string null default 'a', b string null as (concat(a, '-', c)) stored, c string null default 'c')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_stored'\.'
insert into t_stored values ('a1', 'c1'), ('a2', 'c2')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_stored'\.'
insert into t_stored (a) values ('a3'), ('a4')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_stored'\.'
insert into t_stored (c) values ('c5'), ('c6')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_stored'\.'
insert into t_stored (b) values ('b1'), ('b2')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_stored'\.'
insert into t_stored values ('a1', 'b1', 'c1'), ('a2', 'b2', 'c2')

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_stored order by a, c
  \|               \^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored` in catalog 'default'

\.'
select * from t_stored order by a, c

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_stored set a = 'aa', c = 'cc' where a = 'a4'
  \|        \^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored` in catalog 'default'

\.'
update t_stored set a = 'aa', c = 'cc' where a = 'a4'

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_stored set b = 'bb', c = 'cc'
  \|        \^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored` in catalog 'default'

\.'
update t_stored set b = 'bb', c = 'cc'

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_stored order by a, c
  \|               \^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored` in catalog 'default'

\.'
select * from t_stored order by a, c

statement ok
drop table if exists t_stored2

statement error mysql client error: Server error: `ERROR HY000 \(1105\): LicenseKeyInvalid\. Code: 1402, Text = use of computed_column requires an enterprise license\. current license is invalid for test_tenant, cause: LicenseKeyParseError\. Code: 1401, Text = jwt claim decode failed, cause: Token has expired\.\.'
create table t_stored2(a json null, b uint32 null as (a['id']::uint32) stored, c string null as (a['name']::string) stored)

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_stored2'\.'
insert into t_stored2 values ('{"id":1,"name":"tom"}'), ('{"id":2,"name":"jim"}'),('{"id":3}')

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_stored2
  \|               \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored2` in catalog 'default'

\.'
select * from t_stored2

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_stored2 set a = '\{"id":3, "name":"jack"\}' where b = 3
  \|        \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored2` in catalog 'default'

\.'
update t_stored2 set a = '{"id":3, "name":"jack"}' where b = 3

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_stored2 set c = 'test'
  \|        \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored2` in catalog 'default'

\.'
update t_stored2 set c = 'test'

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_stored2
  \|               \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_stored2` in catalog 'default'

\.'
select * from t_stored2

statement ok
drop table if exists t_stored3

statement error mysql client error: Server error: `ERROR HY000 \(1105\): LicenseKeyInvalid\. Code: 1402, Text = use of computed_column requires an enterprise license\. current license is invalid for test_tenant, cause: LicenseKeyParseError\. Code: 1401, Text = jwt claim decode failed, cause: Token has expired\.\.'
create table t_stored3(a json null, b uint32 null as (a['id']::uint32) stored, c string null as (a['name']::string) stored) bloom_index_columns = 'b, c'

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table `test_computed_column`\.`t_stored3` in catalog 'default'\.'
alter table t_stored3 set options(bloom_index_columns = 'a, b')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table `test_computed_column`\.`t_stored3` in catalog 'default'\.'
alter table t_stored3 set options(bloom_index_columns = 'b')

statement ok
drop table if exists t_virtual

statement error mysql client error: Server error: `ERROR HY000 \(1105\): LicenseKeyInvalid\. Code: 1402, Text = use of computed_column requires an enterprise license\. current license is invalid for test_tenant, cause: LicenseKeyParseError\. Code: 1401, Text = jwt claim decode failed, cause: Token has expired\.\.'
create table t_virtual(a string null default 'a', b string null as (concat(a, '-', c)) virtual, c string null default 'c')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_virtual'\.'
insert into t_virtual values ('a1', 'c1'), ('a2', 'c2')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_virtual'\.'
insert into t_virtual (a) values ('a3'), ('a4')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_virtual'\.'
insert into t_virtual (c) values ('c5'), ('c6')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_virtual'\.'
insert into t_virtual (b) values ('b1'), ('b2')

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_virtual'\.'
insert into t_virtual values ('a1', 'b1', 'c1'), ('a2', 'b2', 'c2')

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_virtual order by a, c
  \|               \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual` in catalog 'default'

\.'
select * from t_virtual order by a, c

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_virtual set a = 'aa', c = 'cc' where a = 'a4'
  \|        \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual` in catalog 'default'

\.'
update t_virtual set a = 'aa', c = 'cc' where a = 'a4'

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_virtual set b = 'bb', c = 'cc'
  \|        \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual` in catalog 'default'

\.'
update t_virtual set b = 'bb', c = 'cc'

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_virtual order by a, c
  \|               \^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual` in catalog 'default'

\.'
select * from t_virtual order by a, c

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table `test_computed_column`\.`t_virtual` in catalog 'default'\.'
alter table t_virtual set options(bloom_index_columns = 'b, c');

statement ok
drop table if exists t_virtual2

statement error mysql client error: Server error: `ERROR HY000 \(1105\): LicenseKeyInvalid\. Code: 1402, Text = use of computed_column requires an enterprise license\. current license is invalid for test_tenant, cause: LicenseKeyParseError\. Code: 1401, Text = jwt claim decode failed, cause: Token has expired\.\.'
create table t_virtual2(a json null, b uint32 null as (a['id']::uint32) virtual, c string null as (a['name']::string) virtual)

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = Unknown table 't_virtual2'\.'
insert into t_virtual2 values ('{"id":1,"name":"tom"}'), ('{"id":2,"name":"jim"}'),('{"id":3}')

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_virtual2
  \|               \^\^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual2` in catalog 'default'

\.'
select * from t_virtual2

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_virtual2 set a = '\{"id":3, "name":"jack"\}' where b = 3
  \|        \^\^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual2` in catalog 'default'

\.'
update t_virtual2 set a = '{"id":3, "name":"jack"}' where b = 3

statement error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:8
  \|
1 \| update t_virtual2 set c = 'test'
  \|        \^\^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual2` in catalog 'default'

\.'
update t_virtual2 set c = 'test'

query error mysql client error: Server error: `ERROR HY000 \(1105\): UnknownTable\. Code: 1025, Text = error: 
  \-\-> SQL:1:15
  \|
1 \| select \* from t_virtual2
  \|               \^\^\^\^\^\^\^\^\^\^ Unknown table `test_computed_column`\.`t_virtual2` in catalog 'default'

\.'
select * from t_virtual2

statement error mysql client error: Server error: `ERROR HY000 \(1105\): LicenseKeyInvalid\. Code: 1402, Text = use of computed_column requires an enterprise license\. current license is invalid for test_tenant, cause: LicenseKeyParseError\. Code: 1401, Text = jwt claim decode failed, cause: Token has expired\.\.'
create table t_virtual3(a json null, b uint32 null as (a['id']::uint32) virtual, c string null as (a['name']::string) virtual) bloom_index_columns = 'b, c'

statement ok
DROP DATABASE test_computed_column
