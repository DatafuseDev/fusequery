# push down filter ProjectSet
statement ok
drop table if exists products;

statement ok
create table products(name varchar, details variant);

statement ok
insert into products (name, details) values ('Laptop', '{"brand": "Dell", "colors": ["Black", "Silver"], "price": 1200, "features": {"ram": "16GB", "storage": "512GB"}}'), ('Smartphone', '{"brand": "Apple", "colors": ["White", "Black"], "price": 999, "features": {"ram": "4GB", "storage": "128GB"}}'), ('Headphones', '{"brand": "Sony", "colors": ["Black", "Blue", "Red"], "price": 150, "features": {"battery": "20h", "bluetooth": "5.0"}}');

query T
explain select name, json_path_query(details, '$.features.*') as all_features, json_path_query_first(details, '$.features.*') as first_feature from products where name = 'Laptop' and first_feature = '16GB' and all_features = '512GB';
----
EvalScalar
├── expressions: [products.name (#0), get(1)(json_path_query (#2)), json_path_query_first(products.details (#1), '$.features.*')]
├── estimated rows: 0.12
└── Filter
    ├── filters: [is_true(TRY_CAST(get(1)(json_path_query (#2)) AS String NULL) = '512GB')]
    ├── estimated rows: 0.12
    └── ProjectSet
        ├── estimated rows: 0.60
        ├── set returning functions: json_path_query(products.details (#1), '$.features.*')
        └── TableScan
            ├── table: default.default.products
            ├── read rows: 3
            ├── read bytes: 358
            ├── partitions total: 1
            ├── partitions scanned: 1
            ├── pruning stats: [segments: <range pruning: 1 to 1>, blocks: <range pruning: 1 to 1, bloom pruning: 1 to 1>]
            ├── push downs: [filters: [and_filters(CAST(products.name (#0) = 'Laptop' AS Boolean NULL), TRY_CAST(json_path_query_first(products.details (#1), '$.features.*') AS String NULL) = '16GB')], limit: NONE]
            └── estimated rows: 0.60

query T
select name, json_path_query(details, '$.features.*') as all_features, json_path_query_first(details, '$.features.*') as first_feature from products where name = 'Laptop' and first_feature = '16GB' and all_features = '512GB';
----
Laptop "512GB" "16GB"

query T
explain select name, json_path_query(details, '$.features.*') as all_features, json_path_query_first(details, '$.features.*') as first_feature from products where name = 'Laptop' and first_feature = '16GB';
----
EvalScalar
├── expressions: [products.name (#0), get(1)(json_path_query (#2)), json_path_query_first(products.details (#1), '$.features.*')]
├── estimated rows: 0.60
└── ProjectSet
    ├── estimated rows: 0.60
    ├── set returning functions: json_path_query(products.details (#1), '$.features.*')
    └── TableScan
        ├── table: default.default.products
        ├── read rows: 3
        ├── read bytes: 358
        ├── partitions total: 1
        ├── partitions scanned: 1
        ├── pruning stats: [segments: <range pruning: 1 to 1>, blocks: <range pruning: 1 to 1, bloom pruning: 1 to 1>]
        ├── push downs: [filters: [and_filters(CAST(products.name (#0) = 'Laptop' AS Boolean NULL), TRY_CAST(json_path_query_first(products.details (#1), '$.features.*') AS String NULL) = '16GB')], limit: NONE]
        └── estimated rows: 0.60

query T
select name, json_path_query(details, '$.features.*') as all_features, json_path_query_first(details, '$.features.*') as first_feature from products where name = 'Laptop' and first_feature = '16GB';
----
Laptop "16GB" "16GB"
Laptop "512GB" "16GB"

statement ok
drop table products;
