statement ok
set enable_merge_into_source_build_bloom = 1;

statement ok
set enable_experimental_merge_into = 1;

statement ok
drop table if exists target_bloom_table;

statement ok
drop table if exists source_bloom_table;

statement ok
create table target_bloom_table(a string,b int);

statement ok
create table source_bloom_table(a string,b int);

statement ok
insert into source_bloom_table values('abc',2),('def',1);

statement ok
insert into source_bloom_table values('ff',18),('kgt',27);

query T
select count(*) from fuse_block('default','source_bloom_table');
----
2

statement ok
insert into target_bloom_table values('ak7',992),('def',213);

statement ok
insert into target_bloom_table values('abc12',22),('mkgt',73);

statement ok
insert into target_bloom_table values('ab77c',93),('dqef',107);

statement ok
insert into target_bloom_table values('falf',189),('krrgt',207);

query T
select count(*) from fuse_block('default','target_bloom_table');
----
4

query T
explain merge into target_bloom_table as t1 using source_bloom_table as t2 on t1.a = t2.a when matched then update * when not matched then insert *;
----
MergeInto:
target_table: default.default.target_bloom_table
├── distributed: false
├── target_build_optimization: false
├── can_try_update_column_only: true
├── can_merge_into_source_build_bloom: true
├── matched update: [condition: None,update set a = a (#0),b = b (#1)]
├── unmatched insert: [condition: None,insert into (a,b) values(CAST(a (#0) AS String NULL),CAST(b (#1) AS Int32 NULL))]
└── Join(Left)
    ├── build keys: [t1.a (#2)]
    ├── probe keys: [t2.a (#0)]
    ├── other filters: []
    ├── Scan
    │   ├── table: default.source_bloom_table
    │   ├── filters: []
    │   ├── order by: []
    │   └── limit: NONE
    └── Scan
        ├── table: default.target_bloom_table
        ├── filters: []
        ├── order by: []
        └── limit: NONE

query TT
merge into target_bloom_table as t1 using source_bloom_table as t2 on t1.a = t2.a when matched then update * when not matched then insert *;
----
3 1

query TT
select * from target_bloom_table order by a,b;
----
ab77c 93
abc 2
abc12 22
ak7 992
def 1
dqef 107
falf 189
ff 18
kgt 27
krrgt 207
mkgt 73

statement ok
set enable_merge_into_source_build_bloom = 0;

statement ok
set enable_experimental_merge_into = 0;
