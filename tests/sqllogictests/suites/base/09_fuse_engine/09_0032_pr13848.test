## test window,agg,join's correctess
statement ok
set enable_experimental_merge_into = 1;

statement ok
set enable_distributed_merge_into = 1;

statement ok
create table merge_target_0(a int,b string);

statement ok
create table merge_source_0(a int,b string);

statement ok
insert into merge_target_0 values(1,'a1'),(2,'b1');

statement ok
insert into merge_target_0 values(3,'a2'),(4,'b2');

statement ok
insert into merge_source_0 values(1,'a3'),(3,'b3');

statement ok
insert into merge_source_0 values(5,'a4'),(6,'b6');

## test window,agg,join
## 1. join test
statement ok
merge into merge_target_0 as t1 using 
(select t2.a,t3.b from merge_source_0 as t2 inner join merge_source_0 as t3 on t2.a = t3.a) as t4
on t4.a = t1.a when matched then update * when not matched then insert *;

query TT
select * from merge_target_0 order by a,b;
-----
1 a3
2 b1
3 b3
4 b2
5 a4
6 b6

statement ok
truncate table merge_source_0;

statement ok
insert into merge_source_0 values(1,'c7'),(3,'c7');

query TT
select * from merge_source_0 order by a,b;
----
1 c7
3 c7

## 2. agg test
statement ok
merge into merge_target_0 as t1 using (select avg(a) as a,b from merge_source_0 group by b) as t2 on t1.a = t2.a
when matched then update * when not matched then insert *;

query TT
select * from merge_target_0 order by a,b;
----
1 a3
2 c7
3 b3
4 b2
5 a4
6 b6

## 2. window func test
statement ok
merge into merge_target_0 as t1 using (select row_number() OVER (PARTITION BY b ORDER BY a) as a,'d1' as b from merge_source_0) as t2 on t1.a = t2.a
when matched then update * when not matched then insert *;

query TT
select * from merge_target_0 order by a,b;
----
1 d1
2 d1
3 b3
4 b2
5 a4
6 b6

### test copy into table unsupport (@youngsofun suppory query)
##statement ok
##create table copy_table_test0(a int,b string);

## test agg
##statement error 1065
##copy into copy_table_test0 from (select avg(a) as a,b from merge_source_0 group by b);

## test window
##statement error 1065
##copy into copy_table_test0 from (select row_number() OVER (PARTITION BY b ORDER BY a) as a,'d1' as b from merge_source_0);

## test join
##statement error 1065
##copy into copy_table_test0 from (select t2.a,t3.b from merge_source_0 as t2 inner join merge_source_0 as t3 on t2.a = t3.a);

statement ok
set enable_distributed_merge_into = 0;

statement ok
set enable_experimental_merge_into = 0;